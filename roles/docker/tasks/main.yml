---
# Docker Environment Preparation Role
# Configure Docker group and pull images

- name: Create docker group if it doesn't exist
  group:
    name: docker
    state: present
  become: true

- name: Add ubuntu user to docker group
  user:
    name: ubuntu
    groups: docker
    append: yes
  become: true

- name: Refresh user groups (apply docker group membership)
  command: newgrp docker
  become: true
  become_user: ubuntu
  ignore_errors: true
  changed_when: false

- name: Pull all Docker images
  command: docker compose -f docker-compose.yml -f docker-compose.mlnode.yml pull
  args:
    chdir: "{{ gonka_deploy_dir }}"
  async: "{{ docker_timeout }}"
  poll: 60
  register: pull_result

- name: Verify NVIDIA runtime
  command: docker info
  register: docker_info
  failed_when: "'nvidia' not in docker_info.stdout"

- name: Clean up unused Docker images
  command: docker image prune -f
  ignore_errors: true

- name: Show pulled images
  command: docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
  register: image_list
  changed_when: false

- name: Verify compose files are valid
  command: docker compose -f docker-compose.yml -f docker-compose.mlnode.yml config
  args:
    chdir: "{{ gonka_deploy_dir }}"
  register: compose_validation
  failed_when: compose_validation.rc != 0

- name: Display Docker preparation completion
  debug:
    msg: |
      âœ… Docker environment ready on {{ inventory_hostname }}
      ğŸ³ Images pulled: {{ image_list.stdout_lines | length }}
      ğŸ”§ NVIDIA runtime: Configured
      ğŸ“„ Compose files: Valid
      ğŸš€ Ready for container deployment
