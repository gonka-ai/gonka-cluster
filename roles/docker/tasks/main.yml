---
# Docker Environment Preparation Role
# Pull Docker images and validate configuration

- name: Pull all Docker images
  command: docker compose -f docker-compose.yml -f docker-compose.mlnode.yml pull
  args:
    chdir: "{{ gonka_deploy_dir }}"
  async: "{{ docker_timeout }}"
  poll: 60
  register: pull_result

- name: Verify NVIDIA runtime
  command: docker info
  register: docker_info
  failed_when: "'nvidia' not in docker_info.stdout"

- name: Clean up unused Docker images
  command: docker image prune -f
  ignore_errors: true

- name: Show pulled images
  command: docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
  register: image_list
  changed_when: false

- name: Verify compose files are valid
  command: docker compose -f docker-compose.yml -f docker-compose.mlnode.yml config
  args:
    chdir: "{{ gonka_deploy_dir }}"
  register: compose_validation
  failed_when: compose_validation.rc != 0

- name: Display Docker preparation completion
  debug:
    msg: |
      ✅ Docker environment ready on {{ inventory_hostname }}
      🐳 Images pulled: {{ image_list.stdout_lines | length }}
      🔧 NVIDIA runtime: Configured
      📄 Compose files: Valid
      🚀 Ready for container deployment
