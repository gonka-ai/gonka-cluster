---
# Key setup tasks for a single cluster (uses var: cluster_name)

- name: Extract cluster account public key from local key files
  delegate_to: localhost
  become: false
  shell: >
    printf '%s\n' "$KEYRING_PASSWORD" |
    {{ playbook_dir }}/../inferenced keys show gonka-account-key-{{ cluster_name }}
    --keyring-backend file
    --home {{ playbook_dir }}/../gonka-keys-{{ cluster_name }}
  register: account_key_info
  failed_when: "'gonka1' not in account_key_info.stdout"
  environment:
    KEYRING_PASSWORD: "{{ keyring_password }}"

- name: Store cluster account pubkey
  delegate_to: localhost
  become: false
  set_fact:
    "{{ cluster_name }}_account_pubkey": "{{ account_key_info.stdout | regex_findall('\"key\":\"([^\"]+)\"') | first }}"

- name: Get account pubkey for validation
  delegate_to: localhost
  become: false
  set_fact:
    temp_account_pubkey: "{{ lookup('vars', cluster_name + '_account_pubkey') }}"

- name: Validate account key format
  delegate_to: localhost
  become: false
  assert:
    that: temp_account_pubkey is defined and temp_account_pubkey | length > 10
    fail_msg: "Invalid {{ cluster_name }} account key format: {{ temp_account_pubkey }}"

- name: Display key extraction success
  delegate_to: localhost
  become: false
  debug:
    msg: |
      ✅ {{ cluster_name | upper }} Account PubKey Extracted Successfully:
      🔑 PubKey: {{ temp_account_pubkey }}
      📁 Keyring: ./gonka-keys-{{ cluster_name }}

- name: Publish account pubkey to network node hostvars
  delegate_to: localhost
  become: false
  add_host:
    name: "{{ groups[cluster_name + '_network_node'][0] }}"
    "{{ cluster_name }}_account_pubkey": "{{ temp_account_pubkey }}"

- name: Save account pubkey locally for reuse across runs
  copy:
    content: "{{ temp_account_pubkey }}"
    dest: "{{ playbook_dir }}/../account_pubkey_{{ cluster_name }}.txt"
    mode: '0644'
  delegate_to: localhost
  become: false


