---
# Logging Configuration Role
# Configure centralized logging for Gonka services

- name: Create log directory
  file:
    path: "{{ gonka_deploy_dir }}/logs"
    state: directory
    mode: '0755'
    owner: ubuntu
    group: ubuntu

- name: Ensure Docker logging configuration is set without losing other settings
  block:
    - name: Check if daemon.json exists
      stat:
        path: /etc/docker/daemon.json
      register: daemon_json_stat

    - name: Read existing daemon.json
      slurp:
        path: /etc/docker/daemon.json
      register: daemon_json_slurp
      when: daemon_json_stat.stat.exists

    - name: Parse existing daemon.json
      set_fact:
        existing_daemon_json: "{{ (daemon_json_slurp.content | b64decode | from_json) if daemon_json_stat.stat.exists else {} }}"
      when: daemon_json_stat.stat.exists

    - name: Build merged daemon.json with logging options
      set_fact:
        merged_daemon_json: "{{ (existing_daemon_json | default({})) | combine(desired_logging_overrides, recursive=True) }}"
      vars:
        desired_logging_overrides:
          log-driver: json-file
          log-opts:
            max-size: "1g"
            max-file: "10"

    - name: Write merged daemon.json with logging options
      copy:
        content: "{{ merged_daemon_json | to_nice_json }}"
        dest: /etc/docker/daemon.json
        mode: '0644'
      notify: restart docker
  become: true

- name: Display logging configuration
  debug:
    msg: |
      üìù Logging configured on {{ inventory_hostname }}
      üìÅ Log Directory: {{ gonka_deploy_dir }}/logs
      üîß Docker Logging: JSON file driver
      üìä Max Size: 1GB per file, 10 files max

- name: Create log rotation configuration
  copy:
    dest: /etc/logrotate.d/gonka
    content: |
      {{ gonka_deploy_dir }}/logs/*.log {
        daily
        rotate 7
        compress
        missingok
        notifempty
        create 644 ubuntu ubuntu
      }
    mode: '0644'
  become: true

- name: Display log rotation setup
  debug:
    msg: "üîÑ Log rotation configured for Gonka logs"

- name: Configure systemd journal limits
  lineinfile:
    path: /etc/systemd/journald.conf
    line: "SystemMaxUse=100M"
  become: true
  notify: restart systemd-journald
